<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ü–æ–ø—É—Ç—á–∏–∫ Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
    /* –ì–õ–ê–í–ù–û–ï: –ì–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ */
    :root {
        --bg-color: var(--tg-theme-bg-color, #ffffff);
        --text-color: var(--tg-theme-text-color, #000000);
        --hint-color: var(--tg-theme-hint-color, #999999);
        --link-color: var(--tg-theme-link-color, #007aff);
        --button-color: var(--tg-theme-button-color, #007aff);
        --button-text-color: var(--tg-theme-button-text-color, #ffffff);
        --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f7);
        --destructive: #ff3b30;
        --success: #34c759;
        --warning: #ff9500;
        
        --radius-card: 16px;
        --radius-btn: 12px;
        --safe-area-bottom: env(safe-area-inset-bottom, 20px);
    }

    /* –≠—Ç–æ —á–∏–Ω–∏—Ç –≤–µ—Ä—Å—Ç–∫—É –∏–Ω–ø—É—Ç–æ–≤ */
    *, *::before, *::after {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    /* --- –°–¢–†–£–ö–¢–£–†–ê –°–¢–†–ê–ù–ò–¶ --- */
    .tab-nav {
        display: flex;
        background: var(--secondary-bg-color);
        padding: 4px;
        border-radius: 14px;
        margin: 16px;
        position: sticky;
        top: 10px;
        z-index: 100;
        box-shadow: 0 4px 20px rgba(0,0,0,0.04);
    }
    .tab-item {
        flex: 1;
        padding: 10px;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
        color: var(--hint-color);
        border-radius: 10px;
        transition: all 0.2s;
        cursor: pointer;
    }
    .tab-item.active {
        background: var(--bg-color);
        color: var(--text-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .page {
        display: none;
        padding: 0 16px calc(100px + var(--safe-area-bottom)) 16px;
        animation: fadeIn 0.3s ease;
    }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- –ö–ê–†–¢–û–ß–ö–ò --- */
    .card {
        background: var(--secondary-bg-color);
        border-radius: var(--radius-card);
        padding: 16px;
        margin-bottom: 16px;
        width: 100%;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }
    .destination { font-size: 17px; font-weight: 700; line-height: 1.3; }
    .price { font-size: 17px; font-weight: 800; color: var(--button-color); white-space: nowrap; }
    
    .info-row {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
        color: var(--hint-color);
        font-size: 14px;
    }
    .info-item { display: flex; align-items: center; gap: 4px; }

    .card-footer {
        display: flex;
        gap: 10px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(0,0,0,0.05);
    }

    /* --- –ö–ù–û–ü–ö–ò --- */
    .btn {
        flex: 1;
        border: none;
        border-radius: var(--radius-btn);
        padding: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
    }
    .btn:active { transform: scale(0.98); opacity: 0.8; }
    
    .btn-primary { background: var(--button-color); color: var(--button-text-color); }
    .btn-secondary { background: var(--bg-color); color: var(--text-color); border: 1px solid rgba(0,0,0,0.05); }
    .btn-danger { background: rgba(255, 59, 48, 0.1); color: var(--destructive); }
    .btn-sm { padding: 8px 16px; font-size: 13px; }

    /* --- –ü–û–õ–Ø –í–í–û–î–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û) --- */
    .search-bar { display: flex; gap: 12px; margin-bottom: 20px; }
    .search-wrapper { position: relative; flex: 1; }
    .search-input {
        width: 100%;
        background: var(--secondary-bg-color);
        border: none;
        border-radius: 12px;
        padding: 12px 12px 12px 40px;
        font-size: 16px;
        color: var(--text-color);
        outline: none;
    }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
    .icon-btn {
        width: 44px; height: 44px; border: none; background: var(--secondary-bg-color);
        border-radius: 12px; display: flex; align-items: center; justify-content: center;
        color: var(--button-color); cursor: pointer; flex-shrink: 0;
    }

    .input-group { 
        margin-bottom: 16px; 
        width: 100%; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É —Ä–æ–¥–∏—Ç–µ–ª—è */
    }
    .input-label {
        font-size: 12px;
        text-transform: uppercase;
        color: var(--hint-color);
        font-weight: 700;
        margin-bottom: 6px;
        margin-left: 4px;
    }
    .form-control {
        width: 100%; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ 100% */
        background: var(--bg-color);
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 12px;
        padding: 12px;
        font-size: 16px;
        color: var(--text-color);
        font-family: inherit;
        outline: none;
        margin: 0; /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        appearance: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ */
    }
    .form-control:focus { border-color: var(--button-color); }

    /* --- –ü–†–û–ß–ï–ï --- */
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .badge-green { background: rgba(52, 199, 89, 0.15); color: var(--success); }
    .badge-orange { background: rgba(255, 149, 0, 0.15); color: var(--warning); }
    .badge-red { background: rgba(255, 59, 48, 0.15); color: var(--destructive); }

    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
        display: none; align-items: flex-end; backdrop-filter: blur(2px);
    }
    .modal-overlay.open { display: flex; }
    .modal-content {
        background: var(--bg-color); width: 100%; border-radius: 24px 24px 0 0;
        padding: 24px 20px calc(24px + var(--safe-area-bottom));
        transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .modal-overlay.open .modal-content { transform: translateY(0); }
    
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 20px; font-weight: 800; }
    .close-icon { font-size: 24px; color: var(--hint-color); cursor: pointer; padding: 5px; }

    .section-header { font-size: 13px; font-weight: 700; color: var(--hint-color); text-transform: uppercase; margin: 24px 0 12px; }
    .empty-state { text-align: center; padding: 40px 0; color: var(--hint-color); }
    .passenger-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-top: 1px solid rgba(0,0,0,0.05); }
</style>
</head>
<body>
    <!-- –û–®–ò–ë–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
    <div id="auth-error" style="display:none; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>
        <h2>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
        <p style="color: var(--hint-color);">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram.</p>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† -->
    <div id="app-container" style="display:none;">
        
        <!-- –¢–ê–ë–´ -->
        <div class="tab-nav">
            <div id="tab-search" class="tab-item active" onclick="App.navigate('search')">–ü–æ–∏—Å–∫</div>
            <div id="tab-create" class="tab-item" onclick="App.navigate('create')">–°–æ–∑–¥–∞—Ç—å</div>
            <div id="tab-my" class="tab-item" onclick="App.navigate('my')">–ö–∞–±–∏–Ω–µ—Ç</div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê –ü–û–ò–°–ö–ê -->
        <div id="page-search" class="page active">
            <div class="search-bar">
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" class="search-input" placeholder="–û—Ç–∫—É–¥–∞ –∏–ª–∏ –∫—É–¥–∞?" oninput="UI.renderRides()">
                </div>
                <button class="icon-btn" onclick="App.refreshData()">üîÑ</button>
            </div>
            <div id="rides-container"></div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê –°–û–ó–î–ê–ù–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ê –í–ï–†–°–¢–ö–ê) -->
        <div id="page-create" class="page">
            <div class="card">
                <div class="input-group">
                    <div class="input-label">–ú–∞—Ä—à—Ä—É—Ç</div>
                    <input type="text" id="c-dest" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞ ‚Üí –ö–∞–∑–∞–Ω—å">
                </div>
                <div class="input-group">
                    <div class="input-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</div>
                    <input type="text" id="c-time" class="form-control" placeholder="–ó–∞–≤—Ç—Ä–∞ –≤ 10:00">
                </div>
                <div style="display: flex; gap: 12px;">
                    <div class="input-group">
                        <div class="input-label">–ú–µ—Å—Ç</div>
                        <input type="number" id="c-seats" class="form-control" value="3" min="1" max="8">
                    </div>
                    <div class="input-group">
                        <div class="input-label">–¶–µ–Ω–∞ (‚ÇΩ)</div>
                        <input type="number" id="c-price" class="form-control" placeholder="500">
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ê–≤—Ç–æ, –±–∞–≥–∞–∂)</div>
                    <textarea id="c-comment" class="form-control" rows="3" placeholder="–ë–µ–ª—ã–π Ford Focus, –µ—Å—Ç—å –º–µ—Å—Ç–æ –¥–ª—è –±–∞–≥–∞–∂–∞"></textarea>
                </div>
                <button class="btn btn-primary" onclick="App.createRide()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <!-- –ö–ê–ë–ò–ù–ï–¢ -->
        <div id="page-my" class="page">
            <div class="section-header">–Ø –≤–æ–¥–∏—Ç–µ–ª—å</div>
            <div id="my-driver-container"></div>
            
            <div class="section-header">–Ø –ø–∞—Å—Å–∞–∂–∏—Ä</div>
            <div id="my-passenger-container"></div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï -->
    <div id="modal-edit" class="modal-overlay" onclick="App.closeModal(event, 'modal-edit')">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                <div class="close-icon" onclick="App.toggleModal('modal-edit', false)">‚úï</div>
            </div>
            <input type="hidden" id="edit-id">
            <div class="input-group">
                <div class="input-label">–í—Ä–µ–º—è</div>
                <input type="text" id="edit-time" class="form-control">
            </div>
            <div class="input-group">
                <div class="input-label">–¶–µ–Ω–∞</div>
                <input type="number" id="edit-price" class="form-control">
            </div>
            <div class="input-group">
                <div class="input-label">–í—Å–µ–≥–æ –º–µ—Å—Ç (–º–∏–Ω: <span id="edit-min-seats">0</span>)</div>
                <input type="number" id="edit-seats" class="form-control">
            </div>
            <div class="input-group">
                <div class="input-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
                <textarea id="edit-comment" class="form-control" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="App.saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –î–ï–¢–ê–õ–ò (–ò–°–ü–†–ê–í–õ–ï–ù –ß–ê–¢) -->
    <div id="modal-details" class="modal-overlay" onclick="App.closeModal(event, 'modal-details')">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–û –ø–æ–µ–∑–¥–∫–µ</div>
                <div class="close-icon" onclick="App.toggleModal('modal-details', false)">‚úï</div>
            </div>
            <div id="details-body"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, getDoc, query, where, 
            doc, updateDoc, increment, deleteDoc, runTransaction 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const firebaseConfig = {
            apiKey: "AIzaSyDglMcRs4jF5hu8xfVDnovc7sT0JDw8sY0",
            authDomain: "dubrovitsy-c9cdb.firebaseapp.com",
            projectId: "dubrovitsy-c9cdb",
            storageBucket: "dubrovitsy-c9cdb.firebasestorage.app",
            messagingSenderId: "694345177522",
            appId: "1:694345177522:web:ee573498aa77c3bf34acab",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        // –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
        const State = {
            user: { id: null, name: null, username: null },
            data: { allRides: [], myRides: [], myBookings: [], passengers: [] }
        };

        // –£–¢–ò–õ–ò–¢–´
        const Utils = {
            init: () => {
                tg.expand();
                tg.ready();
                
                const unsafe = tg.initDataUnsafe?.user || {};
                const params = new URLSearchParams(window.location.search);

                State.user.id = params.get('uid') || (unsafe.id ? String(unsafe.id) : null);
                State.user.name = params.get('name') || (unsafe.first_name || "User");
                State.user.username = unsafe.username || null;

                if (State.user.id) {
                    document.getElementById('app-container').style.display = 'block';
                    document.getElementById('auth-error').style.display = 'none';
                    App.refreshData();
                } else {
                    document.getElementById('auth-error').style.display = 'flex';
                }
            },
            
            haptic: () => { try { tg.HapticFeedback.impactOccurred('light'); } catch(e){} },
            
            formatPrice: (p) => p ? `${p} ‚ÇΩ` : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ',
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (FIXED)
            openChat: (id, username) => {
                Utils.haptic();
                let cleanUsername = null;
                
                // –ß–∏—Å—Ç–∏–º –Ω–∏–∫–Ω–µ–π–º
                if (username && username !== 'undefined' && username !== 'null' && username.trim() !== '') {
                    cleanUsername = username.replace('@', '').trim();
                }

                if (cleanUsername) {
                    // –°–ø–æ—Å–æ–± 1: –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∏–∫–Ω–µ–π–º (–°–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π)
                    tg.openTelegramLink('https://t.me/' + cleanUsername);
                } else {
                    // –°–ø–æ—Å–æ–± 2: –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ ID
                    // –û–®–ò–ë–ö–ê –ë–´–õ–ê –ó–î–ï–°–¨: tg.openLink('tg://...') –≤—ã–¥–∞–≤–∞–ª –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
                    
                    // –†–ï–®–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É SDK.
                    // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç —Å–∏—Å—Ç–µ–º—É —Å–∞–º—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª tg://
                    const link = document.createElement('a');
                    link.href = 'tg://user?id=' + id;
                    link.click();
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö Android, –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:
                    // window.location.href = 'tg://user?id=' + id;
                }
            }
        };

        // –ë–ê–ó–ê –î–ê–ù–ù–´–•
        const DB = {
            async fetchAll() {
                try {
                    tg.MainButton.showProgress();
                    
                    // –ü–æ–µ–∑–¥–∫–∏
                    const ridesQ = query(collection(db, "rides"), where("is_active", "==", true));
                    const ridesSnap = await getDocs(ridesQ);
                    const rides = ridesSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    
                    State.data.allRides = rides.sort((a,b) => (b.created_at||0) - (a.created_at||0));
                    State.data.myRides = State.data.allRides.filter(r => String(r.driver_id) === String(State.user.id));

                    // –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    const bookQ = query(collection(db, "bookings"), where("passenger_id", "==", String(State.user.id)));
                    const bookSnap = await getDocs(bookQ);
                    State.data.myBookings = bookSnap.docs.map(d => ({id: d.id, ...d.data()}));

                    // –ü–∞—Å—Å–∞–∂–∏—Ä—ã
                    if (State.data.myRides.length > 0) {
                        const passQ = query(collection(db, "bookings"), where("driver_id", "==", String(State.user.id)));
                        const passSnap = await getDocs(passQ);
                        State.data.passengers = passSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    } else {
                        State.data.passengers = [];
                    }

                    UI.renderAll();
                } catch (e) {
                    tg.showAlert("–û—à–∏–±–∫–∞: " + e.message);
                } finally {
                    tg.MainButton.hideProgress();
                }
            },

            async createRide(data) {
                await addDoc(collection(db, "rides"), {
                    ...data,
                    driver_id: String(State.user.id),
                    driver_name: State.user.name,
                    driver_username: State.user.username || '',
                    seats_taken: 0,
                    is_active: true,
                    created_at: Date.now()
                });
            },

            async bookRide(rideId, dest) {
                const rideRef = doc(db, "rides", rideId);
                await runTransaction(db, async (t) => {
                    const rDoc = await t.get(rideRef);
                    if (!rDoc.exists()) throw "–ü–æ–µ–∑–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞";
                    const r = rDoc.data();
                    if (!r.is_active) throw "–ü–æ–µ–∑–¥–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞";
                    
                    const taken = parseInt(r.seats_taken) || 0;
                    const total = parseInt(r.seats) || 0;
                    if (taken >= total) throw "–ú–µ—Å—Ç –±–æ–ª—å—à–µ –Ω–µ—Ç!";

                    const bookingRef = doc(collection(db, "bookings"));
                    // –°–û–•–†–ê–ù–Ø–ï–ú –ù–ò–ö –í–û–î–ò–¢–ï–õ–Ø –í –ë–†–û–ù–¨ (–í–ê–ñ–ù–û –î–õ–Ø –ß–ê–¢–ê)
                    t.set(bookingRef, {
                        ride_id: rideId,
                        driver_id: String(r.driver_id),
                        driver_username: r.driver_username || '', // <--- –í–û–¢ –¢–£–¢
                        passenger_id: String(State.user.id),
                        passenger_name: State.user.name,
                        passenger_username: State.user.username || '',
                        ride_dest: r.destination,
                        notified: false,
                        created_at: Date.now()
                    });
                    t.update(rideRef, { seats_taken: increment(1) });
                });
            },

            async cancelBooking(bookingId, rideId) {
                await runTransaction(db, async (t) => {
                    const rideRef = doc(db, "rides", rideId);
                    t.delete(doc(db, "bookings", bookingId));
                    const rDoc = await t.get(rideRef);
                    if (rDoc.exists()) {
                        t.update(rideRef, { seats_taken: increment(-1) });
                    }
                });
            }
        };

        // –û–¢–†–ò–°–û–í–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê
        const UI = {
            renderAll: () => {
                UI.renderRides();
                UI.renderCabinet();
            },

            renderRides: () => {
                const container = document.getElementById('rides-container');
                const query = (document.getElementById('search-input').value || '').toLowerCase();
                
                const filtered = State.data.allRides.filter(r => 
                    r.destination.toLowerCase().includes(query) || 
                    r.driver_name.toLowerCase().includes(query)
                );

                if (filtered.length === 0) {
                    container.innerHTML = `<div class="empty-state">–ü–æ–µ–∑–¥–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
                    return;
                }

                container.innerHTML = filtered.map(r => {
                    const isMe = String(r.driver_id) === String(State.user.id);
                    const isBooked = State.data.myBookings.some(b => b.ride_id === r.id);
                    const taken = parseInt(r.seats_taken) || 0;
                    const total = parseInt(r.seats) || 0;
                    const free = Math.max(0, total - taken);
                    
                    let btnHTML = '';
                    if (isMe) btnHTML = `<button class="btn btn-secondary" onclick="App.navigate('my')">–≠—Ç–æ –≤–∞—à–∞ –ø–æ–µ–∑–¥–∫–∞</button>`;
                    else if (isBooked) btnHTML = `<button class="btn btn-secondary" disabled>–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã ‚úÖ</button>`;
                    else if (free === 0) btnHTML = `<button class="btn btn-secondary" disabled>–ú–µ—Å—Ç –Ω–µ—Ç ‚ùå</button>`;
                    else btnHTML = `<button class="btn btn-primary" onclick="App.book('${r.id}', '${r.destination}')">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>`;

                    const detailsBtn = `<button class="btn btn-secondary" onclick="App.showDetails('${r.id}')">–ò–Ω—Ñ–æ</button>`;

                    return `
                        <div class="card">
                            <div class="card-header">
                                <div class="destination">${r.destination}</div>
                                <div class="price">${Utils.formatPrice(r.price)}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-item">‚è∞ ${r.time}</div>
                                <div class="info-item">üöó ${r.driver_name}</div>
                                <div class="info-item">üí∫ ${free} —Å–≤–æ–±.</div>
                            </div>
                            <div class="card-footer">
                                ${btnHTML}
                                ${!isMe ? detailsBtn : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderCabinet: () => {
                // –í–û–î–ò–¢–ï–õ–¨
                const drContainer = document.getElementById('my-driver-container');
                if (State.data.myRides.length === 0) {
                    drContainer.innerHTML = `<div class="empty-state">–í—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –ø–æ–µ–∑–¥–æ–∫</div>`;
                } else {
                    drContainer.innerHTML = State.data.myRides.map(r => {
                        const ridePass = State.data.passengers.filter(p => p.ride_id === r.id);
                        const taken = parseInt(r.seats_taken) || 0;
                        const total = parseInt(r.seats) || 0;
                        
                        const passHTML = ridePass.length ? ridePass.map(p => `
                            <div class="passenger-item">
                                <div>üë§ <b>${p.passenger_name}</b></div>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn btn-secondary btn-sm" onclick="Utils.openChat('${p.passenger_id}', '${p.passenger_username || ''}')">–ß–∞—Ç</button>
                                    <button class="btn btn-danger btn-sm" onclick="App.kickPassenger('${p.id}', '${r.id}', '${p.passenger_name}')">‚úï</button>
                                </div>
                            </div>
                        `).join('') : '<div style="font-size:13px; color:#999; padding:10px 0;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>';

                        return `
                            <div class="card">
                                <div class="card-header">
                                    <div class="destination">${r.destination}</div>
                                    <div class="badge ${taken>=total ? 'badge-orange' : 'badge-green'}">${taken}/${total} –º–µ—Å—Ç</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-item">‚è∞ ${r.time}</div>
                                    <div class="info-item">üí∞ ${r.price} ‚ÇΩ</div>
                                </div>
                                <div class="passenger-list">${passHTML}</div>
                                <div class="card-footer">
                                    <button class="btn btn-secondary btn-sm" onclick="App.openEdit('${r.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                                    <button class="btn btn-danger btn-sm" onclick="App.cancelRide('${r.id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // –ü–ê–°–°–ê–ñ–ò–† (–¢–£–¢ –¢–û–ñ–ï –ù–£–ñ–ï–ù –ß–ê–¢)
                const passContainer = document.getElementById('my-passenger-container');
                if (State.data.myBookings.length === 0) {
                    passContainer.innerHTML = `<div class="empty-state">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–µ—Ç</div>`;
                } else {
                    passContainer.innerHTML = State.data.myBookings.map(b => {
                        const r = State.data.allRides.find(ride => ride.id === b.ride_id) || {};
                        const dId = r.driver_id || b.driver_id;
                        const dName = r.driver_username || b.driver_username;
                        
                        return `
                        <div class="card">
                            <div class="card-header"><div class="destination">${b.ride_dest}</div></div>
                            <div class="card-footer">
                                <button class="btn btn-primary btn-sm" onclick="Utils.openChat('${dId}', '${dName || ''}')">–ß–∞—Ç</button>
                                <button class="btn btn-secondary btn-sm" onclick="App.showDetails('${b.ride_id}')">–î–µ—Ç–∞–ª–∏</button>
                                <button class="btn btn-danger btn-sm" onclick="App.cancelBooking('${b.id}', '${b.ride_id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                    `}).join('');
                }
            }
        };

        // –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        window.App = {
            navigate: (page) => {
                Utils.haptic();
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
                document.getElementById('page-' + page).classList.add('active');
                document.getElementById('tab-' + page).classList.add('active');
                if(page === 'search' || page === 'my') App.refreshData();
            },

            refreshData: () => DB.fetchAll(),

            createRide: async () => {
                Utils.haptic();
                const dest = document.getElementById('c-dest').value.trim();
                const time = document.getElementById('c-time').value.trim();
                const seats = parseInt(document.getElementById('c-seats').value);
                const price = document.getElementById('c-price').value.trim();
                const comment = document.getElementById('c-comment').value.trim();

                if (!dest || !time || !seats) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç, –≤—Ä–µ–º—è –∏ –º–µ—Å—Ç–∞!");

                tg.MainButton.showProgress();
                try {
                    await DB.createRide({ destination: dest, time, seats, price, comment });
                    tg.showAlert("‚úÖ –ü–æ–µ–∑–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞");
                    document.getElementById('c-dest').value = '';
                    document.getElementById('c-comment').value = '';
                    App.navigate('my');
                } catch (e) { 
                    tg.showAlert(e.message); 
                } finally { 
                    tg.MainButton.hideProgress(); 
                }
            },

            book: (id, dest) => {
                Utils.haptic();
                tg.showConfirm(`–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ: ${dest}?`, async (ok) => {
                    if(!ok) return;
                    tg.MainButton.showProgress();
                    try {
                        await DB.bookRide(id, dest);
                        tg.showAlert("‚úÖ –£—Å–ø–µ—à–Ω–æ!");
                        App.refreshData();
                        App.navigate('my');
                    } catch(e) { tg.showAlert(e); } finally { tg.MainButton.hideProgress(); }
                });
            },

            cancelBooking: (bid, rid) => {
                Utils.haptic();
                tg.showConfirm("–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å?", async (ok) => {
                    if(ok) {
                        try { await DB.cancelBooking(bid, rid); App.refreshData(); } catch(e) { tg.showAlert(e); }
                    }
                });
            },

            kickPassenger: (bid, rid, name) => {
                Utils.haptic();
                tg.showConfirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞ ${name}?`, async (ok) => {
                    if(ok) {
                        try { await DB.cancelBooking(bid, rid); App.refreshData(); } catch(e) { tg.showAlert(e); }
                    }
                });
            },

            cancelRide: (id) => {
                Utils.haptic();
                tg.showConfirm("–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?", async (ok) => {
                    if(ok) {
                        try {
                            await updateDoc(doc(db, "rides", id), { is_active: false });
                            App.refreshData();
                        } catch(e) { tg.showAlert(e.message); }
                    }
                });
            },

            toggleModal: (id, show) => {
                const el = document.getElementById(id);
                if(show) { el.style.display = 'flex'; setTimeout(()=>el.classList.add('open'), 10); } 
                else { el.classList.remove('open'); setTimeout(()=>el.style.display='none', 300); }
            },
            closeModal: (e, id) => { if(e.target.id === id) App.toggleModal(id, false); },
            
            openEdit: (id) => {
                const r = State.data.myRides.find(x => x.id === id);
                if(!r) return;
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-time').value = r.time;
                document.getElementById('edit-price').value = r.price;
                document.getElementById('edit-seats').value = r.seats;
                document.getElementById('edit-comment').value = r.comment || '';
                document.getElementById('edit-min-seats').innerText = r.seats_taken;
                App.toggleModal('modal-edit', true);
            },

            saveEdit: async () => {
                const id = document.getElementById('edit-id').value;
                const r = State.data.myRides.find(x => x.id === id);
                const seats = parseInt(document.getElementById('edit-seats').value);
                if(seats < r.seats_taken) return tg.showAlert("–ù–µ–ª—å–∑—è —É–º–µ–Ω—å—à–∏—Ç—å –º–µ—Å—Ç–∞ –Ω–∏–∂–µ –∑–∞–Ω—è—Ç—ã—Ö!");
                try {
                    await updateDoc(doc(db, "rides", id), {
                        time: document.getElementById('edit-time').value,
                        price: document.getElementById('edit-price').value,
                        seats: seats,
                        comment: document.getElementById('edit-comment').value
                    });
                    App.toggleModal('modal-edit', false);
                    App.refreshData();
                } catch(e) { tg.showAlert(e.message); }
            },

            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–ï–¢–ê–õ–ï–ô (–î–õ–Ø –ß–ê–¢–ê)
            showDetails: async (id) => {
                let r = State.data.allRides.find(x => x.id === id);
                if (!r) {
                    try {
                        const snap = await getDoc(doc(db, "rides", id));
                        if(snap.exists()) r = {id: snap.id, ...snap.data()};
                    } catch(e) {}
                }
                
                if(!r) return tg.showAlert("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
                
                document.getElementById('details-body').innerHTML = `
                    <h2 style="margin:0 0 4px">${r.destination}</h2>
                    <div style="color:var(--hint-color); margin-bottom:16px">‚è∞ ${r.time}</div>
                    
                    <div class="card">
                        <div class="info-row" style="margin:0">
                            <div>üë§ –í–æ–¥–∏—Ç–µ–ª—å: <b>${r.driver_name}</b></div>
                        </div>
                        <div class="info-row" style="margin-top:8px">
                            <div>üí∞ –¶–µ–Ω–∞: <b>${r.price} ‚ÇΩ</b></div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom:24px">
                        <div class="input-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
                        <div>${r.comment || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                    </div>

                    <!-- –ü–ï–†–ï–î–ê–ï–ú –ò–ú–Ø –í–û–î–ò–¢–ï–õ–Ø -->
                    <button class="btn btn-primary" onclick="Utils.openChat('${r.driver_id}', '${r.driver_username || ''}')">–ù–∞–ø–∏—Å–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª—é</button>
                `;
                App.toggleModal('modal-details', true);
            }
        };

        window.Utils = Utils;
        window.App = App;
        window.UI = UI; // –ù—É–∂–Ω–æ –¥–ª—è oninput –≤ –ø–æ–∏—Å–∫–µ
        Utils.init();
    </script>
</body>
</html>