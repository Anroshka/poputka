<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–ø—É—Ç—á–∏–∫ ‚Äî Premium App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –¢–≤–æ–π CSS –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø—Ä–æ–ø—É—Å–∫–∞—é –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏) */
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f7);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #007aff);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
            --accent-soft: rgba(0, 122, 255, 0.1);
            --radius-lg: 20px;
            --radius-md: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; line-height: 1.5; overflow-x: hidden; }
        .app-container { min-height: 100vh; display: flex; flex-direction: column; padding: 16px; padding-bottom: 30px; }
        h1 { font-size: 24px; font-weight: 700; margin: 0 0 16px 0; letter-spacing: -0.5px; }
        .tab-bar { background: var(--secondary-bg); padding: 4px; border-radius: var(--radius-md); display: flex; margin-bottom: 20px; position: sticky; top: 10px; z-index: 100; }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; color: var(--hint-color); transition: var(--transition); z-index: 2; }
        .tab.active { color: var(--text-color); }
        .tab-indicator { position: absolute; height: calc(100% - 8px); width: calc(33.33% - 5px); background: var(--bg-color); border-radius: 10px; top: 4px; left: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: var(--transition); }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--secondary-bg); border-radius: var(--radius-lg); padding: 16px; margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.03); }
        .ride-title { font-weight: 700; font-size: 17px; margin-bottom: 4px; }
        .ride-meta { font-size: 13px; color: var(--hint-color); display: flex; gap: 12px; margin-bottom: 10px; }
        .ride-price { font-weight: 800; color: var(--button-color); font-size: 16px; }
        .input-group { margin-bottom: 16px; }
        .label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--hint-color); margin-bottom: 6px; padding-left: 4px; }
        input, textarea { width: 100%; background: var(--bg-color); border: 1px solid transparent; border-radius: var(--radius-md); padding: 14px; font-size: 16px; color: var(--text-color); outline: none; transition: var(--transition); }
        input:focus { border-color: var(--button-color); box-shadow: 0 0 0 4px var(--accent-soft); }
        .btn { background: var(--button-color); color: var(--button-text); border: none; width: 100%; padding: 16px; border-radius: var(--radius-lg); font-size: 16px; font-weight: 700; cursor: pointer; transition: var(--transition); }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1.5px solid var(--button-color); color: var(--button-color); }
        .btn-danger { background: #ff3b30; color: white !important; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--hint-color); }
        .loader { text-align: center; padding: 20px; font-weight: 600; color: var(--button-color); }
        .tag { background: var(--accent-soft); color: var(--button-color); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; display: inline-block; }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>–ü–æ–ø—É—Ç—á–∏–∫</h1>

        <div class="tab-bar">
            <div class="tab-indicator" id="indicator"></div>
            <div class="tab active" onclick="switchTab('search', 0)">–ù–∞–π—Ç–∏</div>
            <div class="tab" onclick="switchTab('offer', 1)">–°–æ–∑–¥–∞—Ç—å</div>
            <div class="tab" onclick="switchTab('my', 2)">–ú–æ–∏</div>
        </div>

        <div id="screen-search" class="screen active">
            <div class="input-group">
                <input type="text" id="search-q" placeholder="–ö—É–¥–∞ –µ–¥–µ–º? (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥–æ–ª—å—Å–∫)" oninput="loadRides()">
            </div>
            <div id="rides-list"></div>
        </div>

        <div id="screen-offer" class="screen">
            <div class="card">
                <div class="input-group"><span class="label">–ö—É–¥–∞</span><input type="text" id="off-dest" placeholder="–ù–∞–ø—Ä: –î—É–±—Ä–æ–≤–∏—Ü—ã - –ü–æ–¥–æ–ª—å—Å–∫"></div>
                <div class="input-group"><span class="label">–ö–æ–≥–¥–∞</span><input type="text" id="off-time" placeholder="–°–µ–≥–æ–¥–Ω—è, 18:00"></div>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;"><span class="label">–ú–µ—Å—Ç</span><input type="number" id="off-seats" value="3"></div>
                    <div style="flex: 1;"><span class="label">–¶–µ–Ω–∞</span><input type="text" id="off-price" placeholder="100—Ä"></div>
                </div>
                <div class="input-group" style="margin-top:16px;"><span class="label">–ò–Ω—Ñ–æ</span><textarea id="off-comm" rows="2" placeholder="–ú–∞—à–∏–Ω–∞, –º–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏..."></textarea></div>
                <button class="btn" onclick="submitOffer()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div id="screen-my" class="screen">
            <div id="my-rides-list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDglMcRs4jF5hu8xfVDnovc7sT0JDw8sY0",
            authDomain: "dubrovitsy-c9cdb.firebaseapp.com",
            projectId: "dubrovitsy-c9cdb",
            storageBucket: "dubrovitsy-c9cdb.firebasestorage.app",
            messagingSenderId: "694345177522",
            appId: "1:694345177522:web:ee573498aa77c3bf34acab",
            measurementId: "G-BHE2YXPK4E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const tg = window.Telegram.WebApp;
        tg.expand();

        const user = tg.initDataUnsafe.user || { id: 1, first_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" };
        const userId = user.id;

        window.switchTab = (screenId, index) => {
            document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
            document.getElementById("screen-" + screenId).classList.add("active");
            document.querySelectorAll(".tab")[index].classList.add("active");
            document.getElementById("indicator").style.left = `calc(${index * 33.33}% + 4px)`;
            if(screenId === "search") loadRides();
            if(screenId === "my") loadMyRides();
        };

        window.loadRides = async () => {
            const list = document.getElementById("rides-list");
            list.innerHTML = `<div class="loader">–ò—â–µ–º –ø–æ–µ–∑–¥–∫–∏...</div>`;
            const searchQ = document.getElementById("search-q").value.toLowerCase();
            
            const q = query(collection(db, "rides"), where("is_active", "==", true));
            const snap = await getDocs(q);
            
            let rides = [];
            snap.forEach(d => rides.push({id: d.id, ...d.data()}));
            
            if (searchQ) rides = rides.filter(r => r.destination.toLowerCase().includes(searchQ));

            if (rides.length === 0) {
                list.innerHTML = `<div class="empty-state">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏ üòî</div>`;
                return;
            }

            list.innerHTML = rides.map(r => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <div class="ride-title">üìç ${r.destination}</div>
                            <div class="ride-meta"><span>‚è∞ ${r.time}</span> <span>üí∫ –°–≤–æ–±: ${r.seats - r.seats_taken}</span></div>
                            <div style="font-size:13px; margin-bottom:8px;">üë®‚Äç‚úàÔ∏è <b>${r.driver_name}</b></div>
                        </div>
                        <div class="ride-price">${r.price}</div>
                    </div>
                    ${r.driver_id == userId ? `<div class="tag">–í–∞—à–∞ –ø–æ–µ–∑–¥–∫–∞</div>` : 
                    `<button class="btn btn-outline" style="padding:10px;" onclick="bookRide('${r.id}')">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>`}
                </div>
            `).join("");
        };

        window.submitOffer = async () => {
    const dest = document.getElementById("off-dest").value;
    const time = document.getElementById("off-time").value;
    const seats = document.getElementById("off-seats").value;
    const price = document.getElementById("off-price").value;
    const comm = document.getElementById("off-comm").value;

    if(!dest || !time) {
        return tg.showAlert("‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –∏ –≤—Ä–µ–º—è!");
    }

    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ, —á—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—à–ª–∞
        tg.MainButton.setText("–ü—É–±–ª–∏–∫–∞—Ü–∏—è...").show();
        
        console.log("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ Firebase...");
        
        await addDoc(collection(db, "rides"), {
            driver_id: userId,
            driver_name: user.first_name || "–í–æ–¥–∏—Ç–µ–ª—å",
            destination: dest,
            time: time,
            seats: parseInt(seats),
            seats_taken: 0,
            price: price,
            comment: comm,
            is_active: true,
            created_at: new Date()
        });

        tg.MainButton.hide();
        tg.showAlert("‚úÖ –ü–æ–µ–∑–¥–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!");
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        document.getElementById("off-dest").value = "";
        document.getElementById("off-time").value = "";
        
        switchTab("my", 2); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ "–ú–æ–∏"
    } catch (e) {
        tg.MainButton.hide();
        console.error(e);
        // –ï—Å–ª–∏ –±–∞–∑–∞ –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É, –º—ã —É–≤–∏–¥–∏–º –µ—ë –≤ –∞–ª–µ—Ä—Ç–µ
        tg.showAlert(" –û—à–∏–±–∫–∞ Firebase: " + e.message);
    }
};

        window.bookRide = async (rideId) => {
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–Ω—è—Ç—ã—Ö –º–µ—Å—Ç
            const rideRef = doc(db, "rides", rideId);
            await updateDoc(rideRef, { seats_taken: increment(1) });
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
            await addDoc(collection(db, "bookings"), {
                ride_id: rideId,
                passenger_id: userId,
                status: "active"
            });

            tg.showAlert("üéâ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ!");
            loadRides();
        };

        window.loadMyRides = async () => {
            const list = document.getElementById("my-rides-list");
            list.innerHTML = `<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
            
            // –ò—â–µ–º –≥–¥–µ —è –≤–æ–¥–∏—Ç–µ–ª—å
            const qD = query(collection(db, "rides"), where("driver_id", "==", userId), where("is_active", "==", true));
            const snapD = await getDocs(qD);
            
            let html = "";
            snapD.forEach(d => {
                const r = d.data();
                html += `
                    <div class="card">
                        <div class="ride-title">üöÄ ${r.destination}</div>
                        <button class="btn btn-danger" style="padding:8px; margin-top:10px;" onclick="cancelRide('${d.id}')">–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
                    </div>`;
            });

            if(!html) html = `<div class="empty-state">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫</div>`;
            list.innerHTML = html;
        };

        window.cancelRide = async (id) => {
            await updateDoc(doc(db, "rides", id), { is_active: false });
            loadMyRides();
        };

        loadRides();
    </script>
</body>
</html>