<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–ø—É—Ç—á–∏–∫ ‚Äî Premium App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f7);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #007aff);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
            --accent-soft: rgba(0, 122, 255, 0.1);
            --radius-lg: 20px;
            --radius-md: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            line-height: 1.5;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 16px;
            padding-bottom: 30px;
        }

        h1 { font-size: 24px; font-weight: 700; margin: 0 0 16px 0; letter-spacing: -0.5px; }
        
        .tab-bar {
            background: var(--secondary-bg);
            padding: 4px; border-radius: var(--radius-md);
            display: flex; margin-bottom: 20px; position: sticky;
            top: 10px; z-index: 100;
        }
        .tab {
            flex: 1; padding: 10px; text-align: center;
            font-size: 13px; font-weight: 600; cursor: pointer;
            color: var(--hint-color); transition: var(--transition);
            z-index: 2;
        }
        .tab.active { color: var(--text-color); }
        .tab-indicator {
            position: absolute; height: calc(100% - 8px); width: calc(33.33% - 5px);
            background: var(--bg-color); border-radius: 10px; top: 4px; left: 4px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: var(--transition);
        }

        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--secondary-bg); border-radius: var(--radius-lg);
            padding: 16px; margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.03);
        }
        .ride-title { font-weight: 700; font-size: 17px; margin-bottom: 4px; }
        .ride-meta { font-size: 13px; color: var(--hint-color); display: flex; gap: 12px; margin-bottom: 10px; }
        .ride-price { font-weight: 800; color: var(--button-color); font-size: 16px; }

        .input-group { margin-bottom: 16px; }
        .label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--hint-color); margin-bottom: 6px; padding-left: 4px; }
        input, textarea {
            width: 100%; background: var(--bg-color); border: 1px solid transparent;
            border-radius: var(--radius-md); padding: 14px; font-size: 16px;
            color: var(--text-color); outline: none; transition: var(--transition);
        }
        input:focus { border-color: var(--button-color); box-shadow: 0 0 0 4px var(--accent-soft); }

        .btn {
            background: var(--button-color); color: var(--button-text);
            border: none; width: 100%; padding: 16px; border-radius: var(--radius-lg);
            font-size: 16px; font-weight: 700; cursor: pointer; transition: var(--transition);
        }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1.5px solid var(--button-color); color: var(--button-color); }
        .btn-danger { background: #ff3b30; color: white !important; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--hint-color); }
        .loader { text-align: center; padding: 20px; font-weight: 600; color: var(--button-color); }

        .tag {
            background: var(--accent-soft); color: var(--button-color);
            padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; display: inline-block;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <h1>–ü–æ–ø—É—Ç—á–∏–∫</h1>

        <div class="tab-bar">
            <div class="tab-indicator" id="indicator"></div>
            <div class="tab active" onclick="switchTab('search', 0)">–ù–∞–π—Ç–∏</div>
            <div class="tab" onclick="switchTab('offer', 1)">–°–æ–∑–¥–∞—Ç—å</div>
            <div class="tab" onclick="switchTab('my', 2)">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</div>
        </div>

        <div id="screen-search" class="screen active">
            <div class="input-group">
                <input type="text" id="search-q" placeholder="–ö—É–¥–∞ –µ–¥–µ–º? (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞)" oninput="loadRides()">
            </div>
            <div id="rides-list"></div>
        </div>

        <div id="screen-offer" class="screen">
            <div class="card">
                <div class="input-group">
                    <span class="label">–ú–∞—Ä—à—Ä—É—Ç</span>
                    <input type="text" id="off-dest" placeholder="–ì–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è">
                </div>
                <div class="input-group">
                    <span class="label">–ö–æ–≥–¥–∞</span>
                    <input type="text" id="off-time" placeholder="–°–µ–≥–æ–¥–Ω—è, 18:00">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-group" style="flex: 1;">
                        <span class="label">–ú–µ—Å—Ç</span>
                        <input type="number" id="off-seats" value="3">
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <span class="label">–¶–µ–Ω–∞</span>
                        <input type="text" id="off-price" placeholder="500—Ä">
                    </div>
                </div>
                <div class="input-group">
                    <span class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
                    <textarea id="off-comm" rows="2" placeholder="–ê–≤—Ç–æ, –¥–µ—Ç–∞–ª–∏..."></textarea>
                </div>
                <button class="btn" onclick="submitOffer()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div id="screen-my" class="screen">
            <div id="my-rides-list"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const API_BASE = ""; // –ü—É—Å—Ç–æ, –µ—Å–ª–∏ API –Ω–∞ —Ç–æ–º –∂–µ –¥–æ–º–µ–Ω–µ, –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ ngrok URL

        const userId = tg.initDataUnsafe.user?.id || 123456789;

        function switchTab(screenId, index) {
            document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
            
            document.getElementById("screen-" + screenId).classList.add("active");
            document.querySelectorAll(".tab")[index].classList.add("active");
            
            const indicator = document.getElementById("indicator");
            indicator.style.left = `calc(${index * 33.33}% + 4px)`;

            if(screenId === "search") loadRides();
            if(screenId === "my") loadMyRides();
        }

        async function apiCall(path, method = "GET", data = null) {
            try {
                const url = API_BASE ? `${API_BASE}${path}` : path;
                const options = {
                    method: method,
                    headers: { "Content-Type": "application/json" }
                };
                
                if (method === "GET") {
                    const sep = path.includes("?") ? "&" : "?";
                    const fullUrl = `${url}${sep}user_id=${userId}`;
                    const res = await fetch(fullUrl, { method: "GET" });
                    return await res.json();
                }

                if (data) options.body = JSON.stringify({ ...data, user_id: userId });
                const response = await fetch(url, options);
                return await response.json();
            } catch (e) {
                console.error("API Error:", e);
                return null;
            }
        }

        async function loadRides() {
            const list = document.getElementById("rides-list");
            list.innerHTML = `<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
            
            const q = document.getElementById("search-q").value;
            const data = await apiCall(`/api/rides?query=${encodeURIComponent(q)}`);
            
            if (!data || data.length === 0) {
                list.innerHTML = `<div class="empty-state">–ü–æ–µ–∑–¥–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç üòî</div>`;
                return;
            }

            list.innerHTML = data.map(r => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div class="ride-title">üìç ${r.destination}</div>
                            <div class="ride-meta">
                                <span>‚è∞ ${r.time}</span>
                                <span>üí∫ –°–≤–æ–±–æ–¥–Ω–æ: ${r.seats - r.taken}</span>
                            </div>
                            <div style="font-size: 13px; margin-bottom: 8px;">üë®‚Äç‚úàÔ∏è <b>${r.driver_name}</b></div>
                            ${r.comment ? `<div style="font-size: 12px; color: var(--hint-color); margin-bottom: 10px;">üí¨ ${r.comment}</div>` : ""}
                        </div>
                        <div class="ride-price">${r.price}</div>
                    </div>
                    ${r.driver_id == userId ? `<div class="tag">–≠—Ç–æ –≤–∞—à–∞ –ø–æ–µ–∑–¥–∫–∞</div>` : `<button class="btn btn-outline" style="padding: 10px; font-size: 14px;" onclick="bookRide(${r.id})">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>`}
                </div>
            `).join("");
        }

        async function loadMyRides() {
            const list = document.getElementById("my-rides-list");
            list.innerHTML = `<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
            
            const data = await apiCall(`/api/my_rides`);
            if (!data) return;

            let html = "";
            if (data.driver.length > 0) {
                html += `<div class="label" style="margin-top: 10px;">–Ø –≤–æ–¥–∏—Ç–µ–ª—å</div>`;
                html += data.driver.map(r => `
                    <div class="card">
                        <div class="ride-title">üöÄ ${r.dest}</div>
                        <div class="ride-meta"><span>‚è∞ ${r.time}</span> <span>üë• ${r.taken}/${r.seats} –º–µ—Å—Ç</span></div>
                        <button class="btn btn-danger" style="padding: 8px; font-size: 13px; font-weight:bold;" onclick="cancelRide(${r.id}, 'driver')">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
                    </div>
                `).join("");
            }

            if (data.passenger.length > 0) {
                html += `<div class="label" style="margin-top: 20px;">–Ø –ø–∞—Å—Å–∞–∂–∏—Ä</div>`;
                html += data.passenger.map(r => `
                    <div class="card">
                        <div class="ride-title">üöó ${r.dest}</div>
                        <div class="ride-meta"><span>‚è∞ ${r.time}</span> <span>üë§ ${r.driver_name}</span></div>
                        <button class="btn btn-outline" style="padding: 8px; font-size: 13px;" onclick="cancelRide(${r.id}, 'passenger')">–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å</button>
                    </div>
                `).join("");
            }

            if (!html) html = `<div class="empty-state">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫</div>`;
            list.innerHTML = html;
        }

        async function submitOffer() {
            const dest = document.getElementById("off-dest").value;
            const time = document.getElementById("off-time").value;
            const seats = document.getElementById("off-seats").value;
            const price = document.getElementById("off-price").value;
            const comment = document.getElementById("off-comm").value;

            if(!dest || !time) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –∏ –≤—Ä–µ–º—è");

            const res = await apiCall("/api/offer", "POST", {
                destination: dest, time: time, seats: seats, price: price, comment: comment
            });

            if (res) {
                tg.showAlert("–ü–æ–µ–∑–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!");
                switchTab("my", 2);
            }
        }

        async function bookRide(rideId) {
            const res = await apiCall("/api/book", "POST", { ride_id: rideId });
            if (res && res.status === "ok") {
                tg.showAlert("–£—Å–ø–µ—Ö! –ú–µ—Å—Ç–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ.");
                loadRides();
            } else if (res) {
                tg.showAlert("–û—à–∏–±–∫–∞: " + res.message);
            }
        }

        async function cancelRide(rideId, role) {
            tg.showConfirm(role === "driver" ? "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?" : "–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å?", async (ok) => {
                if (ok) {
                    await apiCall("/api/cancel", "POST", { ride_id: rideId, role: role });
                    loadMyRides();
                }
            });
        }

        loadRides();
    </script>
</body>
</html>
