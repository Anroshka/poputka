<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–ø—É—Ç—á–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å */
        body { font-family: -apple-system, sans-serif; background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); padding: 16px; margin: 0; }
        .tab-bar { display: flex; background: var(--tg-theme-secondary-bg-color, #f4f4f7); padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 14px; font-weight: 600; color: #999; cursor: pointer; border-radius: 8px; }
        .tab.active { background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .screen { display: none; }
        .screen.active { display: block; }
        .card { background: var(--tg-theme-secondary-bg-color, #f4f4f7); padding: 16px; border-radius: 16px; margin-bottom: 10px; }
        .row { display: flex; justify-content: space-between; align-items: center; }
        .title { font-weight: bold; font-size: 16px; }
        .price { font-weight: 800; color: #007aff; }
        .meta { font-size: 13px; color: #888; margin-top: 5px; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #eee; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; background: #007aff; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .btn-outline { background: transparent; border: 1px solid #007aff; color: #007aff; }
        .btn-red { background: #ff3b30; color: white; padding: 8px; font-size: 13px; margin-top: 10px; width: auto; }
    </style>
</head>
<body>

    <div class="tab-bar">
        <div class="tab active" onclick="switchTab('search')">–ù–∞–π—Ç–∏</div>
        <div class="tab" onclick="switchTab('create')">–°–æ–∑–¥–∞—Ç—å</div>
        <div class="tab" onclick="switchTab('my')">–ú–æ–∏</div>
    </div>

    <!-- –ü–û–ò–°–ö -->
    <div id="scr-search" class="screen active">
        <input type="text" id="s-query" placeholder="–ö—É–¥–∞ –µ–¥–µ–º?" oninput="loadRides()">
        <div id="list-search"></div>
    </div>

    <!-- –°–û–ó–î–ê–ù–ò–ï -->
    <div id="scr-create" class="screen">
        <div class="card">
            <input type="text" id="c-dest" placeholder="–û—Ç–∫—É–¥–∞ - –ö—É–¥–∞">
            <input type="text" id="c-time" placeholder="–í—Ä–µ–º—è (–°–µ–≥–æ–¥–Ω—è 18:00)">
            <div class="row" style="gap:10px">
                <input type="number" id="c-seats" placeholder="–ú–µ—Å—Ç" value="3">
                <input type="text" id="c-price" placeholder="–¶–µ–Ω–∞">
            </div>
            <textarea id="c-comm" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
            <button class="btn" onclick="createRide()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–ò -->
    <div id="scr-my" class="screen">
        <div id="list-my"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDglMcRs4jF5hu8xfVDnovc7sT0JDw8sY0",
            authDomain: "dubrovitsy-c9cdb.firebaseapp.com",
            projectId: "dubrovitsy-c9cdb",
            storageBucket: "dubrovitsy-c9cdb.firebasestorage.app",
            messagingSenderId: "694345177522",
            appId: "1:694345177522:web:ee573498aa77c3bf34acab",
            measurementId: "G-BHE2YXPK4E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        // --- –£–ú–ù–ê–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        let userId, userName;
        
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userId = String(tg.initDataUnsafe.user.id);
            userName = tg.initDataUnsafe.user.first_name;
        } else {
            // –ï—Å–ª–∏ –¢–ì –Ω–µ –æ—Ç–¥–∞–ª –¥–∞–Ω–Ω—ã–µ, —Å–æ–∑–¥–∞–µ–º ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
            let localId = localStorage.getItem('guest_id');
            if(!localId) {
                localId = 'guest_' + Math.floor(Math.random() * 10000);
                localStorage.setItem('guest_id', localId);
            }
            userId = localId;
            userName = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('scr-' + tab).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            if (tab === 'search') loadRides();
            if (tab === 'my') loadMyRides();
        };

        window.loadRides = async () => {
            const list = document.getElementById('list-search');
            list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            const qText = document.getElementById('s-query').value.toLowerCase();

            try {
                const q = query(collection(db, "rides"), where("is_active", "==", true));
                const snap = await getDocs(q);
                let rides = [];
                snap.forEach(d => rides.push({id: d.id, ...d.data()}));
                rides.sort((a, b) => b.created_at - a.created_at);
                
                if (qText) rides = rides.filter(r => r.destination.toLowerCase().includes(qText));
                
                list.innerHTML = rides.length ? '' : '–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫';

                rides.forEach(r => {
                    const isMe = String(r.driver_id) === userId;
                    const free = r.seats - (r.seats_taken || 0);
                    
                    list.innerHTML += `
                        <div class="card">
                            <div class="row"><span class="title">üìç ${r.destination}</span> <span class="price">${r.price}</span></div>
                            <div class="meta">‚è∞ ${r.time} ‚Ä¢ üí∫ –°–≤–æ–±: ${free}</div>
                            <div class="meta">üë§ ${r.driver_name}</div>
                            ${isMe ? 
                                '<div class="meta" style="color:blue; font-weight:bold; margin-top:5px;">–í–∞—à–∞ –ø–æ–µ–∑–¥–∫–∞</div>' : 
                                (free > 0 ? `<button class="btn btn-outline" onclick="bookRide('${r.id}', '${r.driver_id}', '${r.destination}')">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>` : '<div class="meta" style="color:red">–ú–µ—Å—Ç –Ω–µ—Ç</div>')
                            }
                        </div>`;
                });
            } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞: " + e.message; }
        };

        window.createRide = async () => {
            const dest = document.getElementById('c-dest').value;
            const time = document.getElementById('c-time').value;
            if(!dest || !time) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");

            try {
                tg.MainButton.showProgress();
                await addDoc(collection(db, "rides"), {
                    driver_id: userId,
                    driver_name: userName,
                    destination: dest,
                    time: time,
                    price: document.getElementById('c-price').value,
                    seats: parseInt(document.getElementById('c-seats').value),
                    seats_taken: 0,
                    comment: document.getElementById('c-comm').value,
                    is_active: true,
                    created_at: Date.now()
                });
                tg.MainButton.hideProgress();
                tg.showAlert("‚úÖ –°–æ–∑–¥–∞–Ω–æ!");
                window.switchTab('my');
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞"); }
        };

        window.bookRide = async (rideId, driverId, dest) => {
            tg.showConfirm("–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å?", async (ok) => {
                if(ok) {
                    await addDoc(collection(db, "bookings"), {
                        ride_id: rideId,
                        driver_id: driverId,
                        passenger_id: userId,
                        passenger_name: userName,
                        ride_dest: dest,
                        notified: false // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –±–æ—Ç–∞!
                    });
                    await updateDoc(doc(db, "rides", rideId), { seats_taken: increment(1) });
                    tg.showAlert("–ì–æ—Ç–æ–≤–æ!");
                    window.switchTab('my');
                }
            });
        };

        window.loadMyRides = async () => {
            const list = document.getElementById('list-my');
            list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            
            // –í–æ–¥–∏—Ç–µ–ª—å
            const qDrv = query(collection(db, "rides"), where("driver_id", "==", userId), where("is_active", "==", true));
            const snapDrv = await getDocs(qDrv);
            
            // –ü–∞—Å—Å–∞–∂–∏—Ä
            const qPass = query(collection(db, "bookings"), where("passenger_id", "==", userId));
            const snapPass = await getDocs(qPass);

            let html = "";
            if(!snapDrv.empty) html += "<h3>–Ø –≤–æ–¥–∏—Ç–µ–ª—å</h3>";
            snapDrv.forEach(d => {
                const r = d.data();
                html += `<div class="card"><div class="title">${r.destination}</div><div class="meta">${r.time}</div><button class="btn btn-red" onclick="delRide('${d.id}')">–£–¥–∞–ª–∏—Ç—å</button></div>`;
            });

            if(!snapPass.empty) html += "<h3>–Ø –ø–∞—Å—Å–∞–∂–∏—Ä</h3>";
            snapPass.forEach(d => {
                const b = d.data();
                html += `<div class="card"><div class="title">${b.ride_dest}</div><div class="meta">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ</div><button class="btn btn-red" onclick="delBook('${d.id}', '${b.ride_id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button></div>`;
            });

            list.innerHTML = html || '<div style="text-align:center; padding:20px; color:#999">–ü—É—Å—Ç–æ</div>';
        };

        window.delRide = async (id) => {
             if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                 await updateDoc(doc(db, "rides", id), { is_active: false });
                 loadMyRides();
             }
        };

        window.delBook = async (bookId, rideId) => {
             if(confirm("–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å?")) {
                 await deleteDoc(doc(db, "bookings", bookId));
                 await updateDoc(doc(db, "rides", rideId), { seats_taken: increment(-1) });
                 loadMyRides();
             }
        };

        loadRides();
    </script>
</body>
</html>