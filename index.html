<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–ø—É—Ç—á–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –¢–æ—Ç –∂–µ CSS, —á—Ç–æ –±—ã–ª —Ä–∞–Ω—å—à–µ */
        :root { --bg: var(--tg-theme-bg-color, #fff); --text: var(--tg-theme-text-color, #000); --btn: var(--tg-theme-button-color, #007aff); --btn-text: var(--tg-theme-button-text-color, #fff); --card-bg: var(--tg-theme-secondary-bg-color, #f4f4f7); --hint: var(--tg-theme-hint-color, #999); }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 16px; -webkit-tap-highlight-color: transparent; }
        .tab-bar { display: flex; background: var(--card-bg); padding: 4px; border-radius: 12px; margin-bottom: 20px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 5px 10px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 14px; font-weight: 600; color: var(--hint); cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .tab.active { background: var(--bg); color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .screen { display: none; padding-bottom: 80px; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); padding: 16px; border-radius: 16px; margin-bottom: 12px; position: relative; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .title { font-weight: 700; font-size: 17px; }
        .price { font-weight: 800; color: var(--btn); font-size: 16px; }
        .meta { font-size: 13px; color: var(--hint); display: flex; gap: 10px; align-items: center; }
        .status-badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: bold; display: inline-block; margin-top: 5px; }
        .badge-driver { background: rgba(0,122,255,0.1); color: var(--btn); }
        .badge-passenger { background: rgba(34,197,94,0.1); color: #22c55e; }
        input, textarea { width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 12px; border: 1px solid transparent; background: var(--bg); color: var(--text); box-sizing: border-box; font-size: 16px; }
        input:focus, textarea:focus { border-color: var(--btn); outline: none; }
        .btn { width: 100%; padding: 16px; background: var(--btn); color: var(--btn-text); border: none; border-radius: 14px; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-outline { background: transparent; border: 1.5px solid var(--btn); color: var(--btn); padding: 10px; font-size: 14px; }
        .btn-red { background: #ff3b30; color: white; font-size: 13px; padding: 8px 12px; width: auto; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="auth-error" style="display:none; text-align:center; padding-top:50px;">
        <h2>‚õî –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h2>
        <p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É.</p>
    </div>

    <div id="app-view">
        <div class="tab-bar">
            <div class="tab active" onclick="switchTab('search')">–ù–∞–π—Ç–∏</div>
            <div class="tab" onclick="switchTab('create')">–°–æ–∑–¥–∞—Ç—å</div>
            <div class="tab" onclick="switchTab('my')">–ú–æ–∏</div>
        </div>

        <!-- –ü–û–ò–°–ö -->
        <div id="scr-search" class="screen active">
            <input type="text" id="s-query" placeholder="üîç –ö—É–¥–∞ –µ–¥–µ–º?" oninput="loadRides()">
            <div id="list-search"></div>
        </div>

        <!-- –°–û–ó–î–ê–ù–ò–ï -->
        <div id="scr-create" class="screen">
            <div class="card">
                <input type="text" id="c-dest" placeholder="–û—Ç–∫—É–¥–∞ - –ö—É–¥–∞">
                <input type="text" id="c-time" placeholder="–í—Ä–µ–º—è (–°–µ–≥–æ–¥–Ω—è 18:00)">
                <div class="row" style="gap:10px">
                    <input type="number" id="c-seats" placeholder="–ú–µ—Å—Ç" value="3">
                    <input type="text" id="c-price" placeholder="–¶–µ–Ω–∞">
                </div>
                <textarea id="c-comm" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                <button class="btn" onclick="createRide()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <!-- –ú–û–ò -->
        <div id="scr-my" class="screen">
            <div id="list-my-driver"></div>
            <div id="list-my-passenger"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDglMcRs4jF5hu8xfVDnovc7sT0JDw8sY0",
            authDomain: "dubrovitsy-c9cdb.firebaseapp.com",
            projectId: "dubrovitsy-c9cdb",
            storageBucket: "dubrovitsy-c9cdb.firebasestorage.app",
            messagingSenderId: "694345177522",
            appId: "1:694345177522:web:ee573498aa77c3bf34acab",
            measurementId: "G-BHE2YXPK4E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        // --- –ñ–ï–õ–ï–ó–û–ë–ï–¢–û–ù–ù–ê–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        // 1. –ß–∏—Ç–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ —Å—Å—ã–ª–∫–∏ (?uid=...&name=...)
        const urlParams = new URLSearchParams(window.location.search);
        const urlId = urlParams.get('uid');
        const urlName = urlParams.get('name');

        let userId = null;
        let userName = null;

        if (urlId) {
            // –ï—Å–ª–∏ –≤ —Å—Å—ã–ª–∫–µ –µ—Å—Ç—å ID - –≤–µ—Ä–∏–º –µ–º—É –Ω–∞ 100%
            userId = urlId;
            userName = urlName || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
        } else if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            userId = String(tg.initDataUnsafe.user.id);
            userName = tg.initDataUnsafe.user.first_name;
        }

        // –ï—Å–ª–∏ –Ω–∏ —Å—Å—ã–ª–∫–∏, –Ω–∏ –¢–ì –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –ë–õ–û–ö–ò–†–£–ï–ú
        if (!userId) {
            document.getElementById('app-view').style.display = 'none';
            document.getElementById('auth-error').style.display = 'block';
        }

        console.log("Logged in as:", userId, userName);

        // --- –î–ê–õ–¨–®–ï –í–°–Å –ü–û-–°–¢–ê–†–û–ú–£ ---

        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('scr-' + tab).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            if (tab === 'search') loadRides();
            if (tab === 'my') loadMyRides();
        };

        window.loadRides = async () => {
            const container = document.getElementById('list-search');
            container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            const qText = document.getElementById('s-query').value.toLowerCase();
            
            try {
                const q = query(collection(db, "rides"), where("is_active", "==", true));
                const snap = await getDocs(q);
                let rides = [];
                snap.forEach(d => rides.push({id: d.id, ...d.data()}));
                rides.sort((a, b) => b.created_at - a.created_at);

                if (qText) rides = rides.filter(r => r.destination.toLowerCase().includes(qText));
                
                container.innerHTML = rides.length ? '' : '<div style="text-align:center; padding:20px; color:#999">–ü–æ–µ–∑–¥–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';

                rides.forEach(r => {
                    const isMe = String(r.driver_id) === userId;
                    const free = r.seats - (r.seats_taken || 0);
                    
                    const btnHtml = isMe 
                        ? `<div class="status-badge badge-driver">–í–∞—à–∞ –ø–æ–µ–∑–¥–∫–∞</div>`
                        : (free > 0 
                            ? `<button class="btn btn-outline" style="width:100%" onclick="bookRide('${r.id}', '${r.driver_id}', '${r.destination}')">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>`
                            : `<div style="color:red; margin-top:5px">–ú–µ—Å—Ç –Ω–µ—Ç</div>`);

                    container.innerHTML += `
                        <div class="card">
                            <div class="row"><span class="title">üìç ${r.destination}</span> <span class="price">${r.price}</span></div>
                            <div class="meta">‚è∞ ${r.time} ‚Ä¢ üí∫ –°–≤–æ–±: ${free}</div>
                            <div class="meta">üë§ ${r.driver_name}</div>
                            ${btnHtml}
                        </div>`;
                });
            } catch (e) { container.innerHTML = "–û—à–∏–±–∫–∞: " + e.message; }
        };

        window.createRide = async () => {
            const dest = document.getElementById('c-dest').value;
            const time = document.getElementById('c-time').value;
            if(!dest || !time) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");

            try {
                tg.MainButton.showProgress();
                await addDoc(collection(db, "rides"), {
                    driver_id: userId,
                    driver_name: userName,
                    destination: dest,
                    time: time,
                    price: document.getElementById('c-price').value,
                    seats: parseInt(document.getElementById('c-seats').value) || 3,
                    seats_taken: 0,
                    comment: document.getElementById('c-comm').value,
                    is_active: true,
                    created_at: Date.now()
                });
                tg.MainButton.hideProgress();
                tg.showAlert("‚úÖ –°–æ–∑–¥–∞–Ω–æ!");
                window.switchTab('my');
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞"); }
        };

        window.bookRide = async (rideId, driverId, dest) => {
            tg.showConfirm(`–ë—Ä–æ–Ω—å: ${dest}?`, async (ok) => {
                if(ok) {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –±—Ä–æ–Ω—å
                    const checkQ = query(collection(db, "bookings"), where("ride_id", "==", rideId), where("passenger_id", "==", userId));
                    const checkSnap = await getDocs(checkQ);
                    if(!checkSnap.empty) return tg.showAlert("–í—ã —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏!");

                    await addDoc(collection(db, "bookings"), {
                        ride_id: rideId,
                        driver_id: driverId,
                        passenger_id: userId,
                        passenger_name: userName,
                        ride_dest: dest,
                        notified: false
                    });
                    await updateDoc(doc(db, "rides", rideId), { seats_taken: increment(1) });
                    tg.showAlert("–ì–æ—Ç–æ–≤–æ!");
                    window.switchTab('my');
                }
            });
        };

        window.loadMyRides = async () => {
            const drv = document.getElementById('list-my-driver');
            const pass = document.getElementById('list-my-passenger');
            drv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...'; pass.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            // –Ø –≤–æ–¥–∏—Ç–µ–ª—å
            const qD = query(collection(db, "rides"), where("driver_id", "==", userId), where("is_active", "==", true));
            const snapD = await getDocs(qD);
            let hD = "<h3>–Ø –í–û–î–ò–¢–ï–õ–¨</h3>";
            snapD.forEach(d => {
                const r = d.data();
                hD += `<div class="card"><div class="title">${r.destination}</div><div class="meta">${r.time} ‚Ä¢ –ó–∞–Ω—è—Ç–æ: ${r.seats_taken}</div><button class="btn btn-red" onclick="delRide('${d.id}')">–£–¥–∞–ª–∏—Ç—å</button></div>`;
            });
            drv.innerHTML = snapD.empty ? "<h3>–Ø –í–û–î–ò–¢–ï–õ–¨</h3><div style='color:#999'>–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</div>" : hD;

            // –Ø –ø–∞—Å—Å–∞–∂–∏—Ä
            const qP = query(collection(db, "bookings"), where("passenger_id", "==", userId));
            const snapP = await getDocs(qP);
            let hP = "<h3>–Ø –ü–ê–°–°–ê–ñ–ò–†</h3>";
            snapP.forEach(d => {
                const b = d.data();
                hP += `<div class="card"><div class="title">${b.ride_dest}</div><div class="status-badge badge-passenger">–ê–∫—Ç–∏–≤–Ω–æ</div><button class="btn btn-red" onclick="delBook('${d.id}', '${b.ride_id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button></div>`;
            });
            pass.innerHTML = snapP.empty ? "<h3>–Ø –ü–ê–°–°–ê–ñ–ò–†</h3><div style='color:#999'>–ù–µ—Ç –±—Ä–æ–Ω–µ–π</div>" : hP;
        };

        window.delRide = async (id) => {
            if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                await updateDoc(doc(db, "rides", id), { is_active: false });
                loadMyRides();
            }
        };

        window.delBook = async (bid, rid) => {
            if(confirm("–û—Ç–º–µ–Ω–∏—Ç—å?")) {
                await deleteDoc(doc(db, "bookings", bid));
                await updateDoc(doc(db, "rides", rid), { seats_taken: increment(-1) });
                loadMyRides();
            }
        };

        loadRides();
    </script>
</body>
</html>