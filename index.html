<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–ø—É—Ç—á–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #fff);
            --text: var(--tg-theme-text-color, #000);
            --btn: var(--tg-theme-button-color, #007aff);
            --btn-text: var(--tg-theme-button-text-color, #fff);
            --card-bg: var(--tg-theme-secondary-bg-color, #f4f4f7);
            --hint: var(--tg-theme-hint-color, #999);
        }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 16px; -webkit-tap-highlight-color: transparent; }
        .tab-bar { display: flex; background: var(--card-bg); padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 14px; font-weight: 600; color: var(--hint); cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .tab.active { background: var(--bg); color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .screen { display: none; }
        .screen.active { display: block; }
        .card { background: var(--card-bg); padding: 16px; border-radius: 16px; margin-bottom: 12px; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .title { font-weight: 700; font-size: 17px; }
        .price { font-weight: 800; color: var(--btn); }
        .meta { font-size: 13px; color: var(--hint); display: flex; gap: 10px; }
        .status-badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: bold; }
        .badge-driver { background: rgba(0,122,255,0.1); color: var(--btn); }
        .badge-passenger { background: rgba(0,200,0,0.1); color: green; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid transparent; background: var(--bg); color: var(--text); box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; background: var(--btn); color: var(--btn-text); border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid var(--btn); color: var(--btn); }
        .btn-red { background: #ff3b30; color: white; font-size: 14px; padding: 8px; margin-top: 10px; }
        .error-screen { text-align: center; padding-top: 50px; display: none; }
    </style>
</head>
<body>

    <div id="error-view" class="error-screen">
        <h2>üîí –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
        <p>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ!</p>
    </div>

    <div id="app-view">
        <div class="tab-bar">
            <div class="tab active" onclick="switchTab('search')">–ù–∞–π—Ç–∏</div>
            <div class="tab" onclick="switchTab('create')">–°–æ–∑–¥–∞—Ç—å</div>
            <div class="tab" onclick="switchTab('my')">–ú–æ–∏</div>
        </div>

        <!-- –ü–û–ò–°–ö -->
        <div id="scr-search" class="screen active">
            <input type="text" id="s-query" placeholder="–ö—É–¥–∞? (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞)" oninput="loadRides()">
            <div id="list-search"></div>
        </div>

        <!-- –°–û–ó–î–ê–ù–ò–ï -->
        <div id="scr-create" class="screen">
            <div class="card">
                <input type="text" id="c-dest" placeholder="–ú–∞—Ä—à—Ä—É—Ç (–û—Ç–∫—É–¥–∞ - –ö—É–¥–∞)">
                <input type="text" id="c-time" placeholder="–í—Ä–µ–º—è (–°–µ–≥–æ–¥–Ω—è 18:00)">
                <div class="row">
                    <input type="number" id="c-seats" placeholder="–ú–µ—Å—Ç" value="3" style="width: 48%">
                    <input type="text" id="c-price" placeholder="–¶–µ–Ω–∞" style="width: 48%">
                </div>
                <textarea id="c-comm" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ê–≤—Ç–æ, –º–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏)"></textarea>
                <button class="btn" onclick="createRide()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <!-- –ú–û–ò –ü–û–ï–ó–î–ö–ò -->
        <div id="scr-my" class="screen">
            <h3 style="margin: 0 0 10px 4px; font-size: 14px; color: var(--hint);">–Ø –í–û–î–ò–¢–ï–õ–¨</h3>
            <div id="list-my-driver"></div>
            
            <h3 style="margin: 20px 0 10px 4px; font-size: 14px; color: var(--hint);">–Ø –ü–ê–°–°–ê–ñ–ò–†</h3>
            <div id="list-my-passenger"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, increment, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDglMcRs4jF5hu8xfVDnovc7sT0JDw8sY0",
            authDomain: "dubrovitsy-c9cdb.firebaseapp.com",
            projectId: "dubrovitsy-c9cdb",
            storageBucket: "dubrovitsy-c9cdb.firebasestorage.app",
            messagingSenderId: "694345177522",
            appId: "1:694345177522:web:ee573498aa77c3bf34acab",
            measurementId: "G-BHE2YXPK4E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const user = tg.initDataUnsafe?.user;
        
        // –°–¢–†–û–ì–ê–Ø –ü–†–û–í–ï–†–ö–ê
        if (!user) {
            document.getElementById('app-view').style.display = 'none';
            document.getElementById('error-view').style.display = 'block';
        }

        const userId = user ? String(user.id) : null;
        const userName = user ? user.first_name : "User";

        // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö
        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById('scr-' + tab).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');

            if (tab === 'search') loadRides();
            if (tab === 'my') loadMyRides();
        };

        // 1. –ó–ê–ì–†–£–ó–ö–ê –î–õ–Ø –ü–û–ò–°–ö–ê
        window.loadRides = async () => {
            const container = document.getElementById('list-search');
            container.innerHTML = 'Wait...';
            const qText = document.getElementById('s-query').value.toLowerCase();
            
            try {
                const q = query(collection(db, "rides"), where("is_active", "==", true));
                const snap = await getDocs(q);
                let rides = [];
                snap.forEach(d => rides.push({id: d.id, ...d.data()}));
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                rides.sort((a, b) => b.created_at - a.created_at);
                if (qText) rides = rides.filter(r => r.destination.toLowerCase().includes(qText));

                container.innerHTML = rides.length ? '' : '<div style="text-align:center; padding:20px; color:#999">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</div>';

                rides.forEach(r => {
                    const isMe = String(r.driver_id) === userId;
                    const free = r.seats - (r.seats_taken || 0);
                    
                    const btnHtml = isMe 
                        ? `<span class="status-badge badge-driver">–í–∞—à–∞ –ø–æ–µ–∑–¥–∫–∞</span>`
                        : (free > 0 
                            ? `<button class="btn btn-outline" style="padding:10px" onclick="bookRide('${r.id}', '${r.driver_id}', '${r.destination}')">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>`
                            : `<span style="color:red; font-size:12px">–ú–µ—Å—Ç –Ω–µ—Ç</span>`);

                    container.innerHTML += `
                        <div class="card">
                            <div class="row"><span class="title">üìç ${r.destination}</span> <span class="price">${r.price}</span></div>
                            <div class="meta">‚è∞ ${r.time} ‚Ä¢ üí∫ –°–≤–æ–±: ${free}</div>
                            <div class="meta" style="margin: 8px 0">üë§ ${r.driver_name}</div>
                            ${btnHtml}
                        </div>`;
                });
            } catch (e) { container.innerHTML = "–û—à–∏–±–∫–∞: " + e.message; }
        };

        // 2. –°–û–ó–î–ê–ù–ò–ï –ü–û–ï–ó–î–ö–ò
        window.createRide = async () => {
            const dest = document.getElementById('c-dest').value;
            const time = document.getElementById('c-time').value;
            const price = document.getElementById('c-price').value;
            const seats = document.getElementById('c-seats').value;
            const comm = document.getElementById('c-comm').value;

            if (!dest || !time) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –∏ –≤—Ä–µ–º—è!");

            try {
                tg.MainButton.setText("–ü—É–±–ª–∏–∫–∞—Ü–∏—è...").show();
                await addDoc(collection(db, "rides"), {
                    driver_id: userId,
                    driver_name: userName,
                    destination: dest,
                    time: time,
                    price: price,
                    seats: parseInt(seats),
                    seats_taken: 0,
                    comment: comm,
                    is_active: true,
                    created_at: Date.now()
                });
                tg.MainButton.hide();
                tg.showAlert("‚úÖ –ü–æ–µ–∑–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!");
                window.switchTab('my');
            } catch (e) { tg.showAlert("Err: " + e.message); tg.MainButton.hide(); }
        };

        // 3. –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ï (–° –£–í–ï–î–û–ú–õ–ï–ù–ò–ï–ú)
        window.bookRide = async (rideId, driverId, destName) => {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª –ª–∏ —è —É–∂–µ
            // (–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ–ø—É—Å—Ç–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, –±–∞–∑–∞ —Å–∞–º–∞ —Ä–∞–∑—Ä—É–ª–∏—Ç –µ—Å–ª–∏ —á—Ç–æ, –Ω–æ –ª—É—á—à–µ —Ç–∞–∫)
            
            tg.showConfirm(`–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ –≤ "${destName}"?`, async (ok) => {
                if (!ok) return;
                try {
                    // 1. –°–æ–∑–¥–∞–µ–º –±—Ä–æ–Ω—å. –í–ê–ñ–ù–û: –ø–æ–ª–µ notified: false –Ω—É–∂–Ω–æ –¥–ª—è –±–æ—Ç–∞
                    await addDoc(collection(db, "bookings"), {
                        ride_id: rideId,
                        driver_id: driverId,
                        passenger_id: userId,
                        passenger_name: userName,
                        ride_dest: destName,
                        created_at: Date.now(),
                        notified: false // <--- –§–õ–ê–ì –î–õ–Ø –ë–û–¢–ê
                    });

                    // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –º–µ—Å—Ç
                    await updateDoc(doc(db, "rides", rideId), {
                        seats_taken: increment(1)
                    });

                    tg.showAlert("–£—Å–ø–µ—à–Ω–æ! –í–æ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.");
                    window.switchTab('my');
                } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞: " + e.message); }
            });
        };

        // 4. –ó–ê–ì–†–£–ó–ö–ê "–ú–û–ò –ü–û–ï–ó–î–ö–ò" (–û–±–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
        window.loadMyRides = async () => {
            const drvList = document.getElementById('list-my-driver');
            const passList = document.getElementById('list-my-passenger');
            drvList.innerHTML = '...'; passList.innerHTML = '...';

            // –ê. –ì–¥–µ —è –≤–æ–¥–∏—Ç–µ–ª—å
            const qDrv = query(collection(db, "rides"), where("driver_id", "==", userId), where("is_active", "==", true));
            const snapDrv = await getDocs(qDrv);
            let htmlDrv = "";
            snapDrv.forEach(d => {
                const r = d.data();
                htmlDrv += `
                    <div class="card">
                        <div class="row"><span class="title">üöÄ ${r.destination}</span> <span class="price">${r.price}</span></div>
                        <div class="meta">‚è∞ ${r.time} ‚Ä¢ –ó–∞–Ω—è—Ç–æ: ${r.seats_taken}/${r.seats}</div>
                        <button class="btn btn-red" onclick="deleteRide('${d.id}')">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
                    </div>`;
            });
            drvList.innerHTML = htmlDrv || '<div style="color:#999; font-size:13px">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫</div>';

            // –ë. –ì–¥–µ —è –ø–∞—Å—Å–∞–∂–∏—Ä
            const qPass = query(collection(db, "bookings"), where("passenger_id", "==", userId));
            const snapPass = await getDocs(qPass);
            let htmlPass = "";
            snapPass.forEach(d => {
                const b = d.data();
                // –¢—É—Ç –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–µ–∑–¥–∫–∏, –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –±—Ä–æ–Ω—å
                htmlPass += `
                    <div class="card">
                        <div class="row"><span class="title">üé´ ${b.ride_dest}</span></div>
                        <div class="meta">–í–æ–¥–∏—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω</div>
                        <button class="btn btn-red" onclick="cancelBooking('${d.id}', '${b.ride_id}')">–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å</button>
                    </div>`;
            });
            passList.innerHTML = htmlPass || '<div style="color:#999; font-size:13px">–ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>';
        };

        // –£–î–ê–õ–ï–ù–ò–ï
        window.deleteRide = async (id) => {
            if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                await updateDoc(doc(db, "rides", id), { is_active: false });
                loadMyRides();
            }
        };

        window.cancelBooking = async (bookingId, rideId) => {
            if(confirm("–°–Ω—è—Ç—å –±—Ä–æ–Ω—å?")) {
                await deleteDoc(doc(db, "bookings", bookingId));
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ—Å—Ç–æ
                await updateDoc(doc(db, "rides", rideId), { seats_taken: increment(-1) });
                loadMyRides();
            }
        };

        // –°—Ç–∞—Ä—Ç
        loadRides();
    </script>
</body>
</html>